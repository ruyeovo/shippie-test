name: MergeWiki (LLM Conflict Resolver)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: mergewiki-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  mergewiki:
    # fork PR 默认拿不到 OPENROUTER_API_KEY，先跳过避免失败刷屏
    if: ${{ github.event.pull_request.draft == false && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base repo (trusted)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0
          persist-credentials: false

      - name: Fetch PR head
        run: |
          git fetch --no-tags origin ${{ github.event.pull_request.head.sha }}:pr_head

      # 关键：不使用 GITHUB_TOKEN 去访问另一个仓库 API（会 404）
      # 关键：不使用 git clone（你环境会触发 Username prompt）
      # 这里采用：匿名 API 尝试读取 default_branch；失败就 fallback main/master；
      # 然后用 codeload 下载 tarball（不走 git）
      - name: Download MergeWiki tool repo (public, no auth)
        run: |
          set -euo pipefail

          OWNER="ruyoevo"
          REPO="MergeWiki"

          rm -rf tools/mergewiki
          mkdir -p tools/mergewiki

          echo "Query default branch (anonymous GitHub API)..."
          API_URL="https://api.github.com/repos/${OWNER}/${REPO}"

          http_code="$(curl -sSL -o /tmp/repo.json -w "%{http_code}" "${API_URL}")" || true
          echo "API status: ${http_code}"

          DEFAULT_BRANCH=""
          if [ "${http_code}" = "200" ]; then
            DEFAULT_BRANCH="$(python3 - <<'PY'
import json
with open('/tmp/repo.json','r',encoding='utf-8') as f:
    j=json.load(f)
print(j.get('default_branch','') or '')
PY
)"
          fi

          if [ -z "${DEFAULT_BRANCH}" ]; then
            echo "WARN: cannot get default_branch via API; fallback to main/master"
            CANDIDATE_BRANCHES=("main" "master")
          else
            echo "Default branch: ${DEFAULT_BRANCH}"
            CANDIDATE_BRANCHES=("${DEFAULT_BRANCH}" "main" "master")
          fi

          FOUND=0
          for br in "${CANDIDATE_BRANCHES[@]}"; do
            url="https://codeload.github.com/${OWNER}/${REPO}/tar.gz/refs/heads/${br}"
            echo "Trying tarball: ${url}"
            if curl -L --fail --retry 3 --retry-delay 2 -o /tmp/mergewiki.tar.gz "${url}"; then
              echo "Downloaded OK from branch: ${br}"
              FOUND=1
              break
            fi
          done

          if [ "${FOUND}" -ne 1 ]; then
            echo "ERROR: cannot download tool tarball."
            echo "Checked branches: ${CANDIDATE_BRANCHES[*]}"
            exit 1
          fi

          rm -rf /tmp/mergewiki_src_
