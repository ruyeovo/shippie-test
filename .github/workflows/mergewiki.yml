name: MergeWiki (LLM Conflict Resolver)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: mergewiki-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  mergewiki:
    # fork PR 默认拿不到 secrets（OPENROUTER_API_KEY），先跳过避免失败刷屏
    if: ${{ github.event.pull_request.draft == false && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout 业务仓库 base commit（可信环境）
      - name: Checkout base repo (trusted)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0
          persist-credentials: false

      # 2) Fetch PR head 到本地分支 pr_head（用于 merge-base/diff）
      - name: Fetch PR head
        run: |
          git fetch --no-tags origin ${{ github.event.pull_request.head.sha }}:pr_head

      # 3) 下载工具仓库：GitHub API 查询 default_branch + tarball 下载并解压
      - name: Download MergeWiki tool repo (via GitHub API tarball)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          OWNER="ruyoevo"
          REPO="MergeWiki"

          rm -rf tools/mergewiki
          mkdir -p tools/mergewiki

          echo "Query default branch via GitHub API..."
          DEFAULT_BRANCH="$(curl -sSfL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}" | jq -r '.default_branch')"

          if [ -z "${DEFAULT_BRANCH}" ] || [ "${DEFAULT_BRANCH}" = "null" ]; then
            echo "ERROR: failed to get default_branch"
            exit 1
          fi

          echo "Default branch: ${DEFAULT_BRANCH}"
          echo "Downloading tarball via API..."
          curl -L --fail --retry 3 --retry-delay 2 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -o /tmp/mergewiki.tar.gz \
            "https://api.github.com/repos/${OWNER}/${REPO}/tarball/${DEFAULT_BRANCH}"

          rm -rf /tmp/mergewiki_src
          mkdir -p /tmp/mergewiki_src
          tar -xzf /tmp/mergewiki.tar.gz -C /tmp/mergewiki_src --strip-components=1
          cp -R /tmp/mergewiki_src/* tools/mergewiki/

          echo "Tool repo contents:"
          ls -la tools/mergewiki

          # 关键文件存在性检查（尽早失败）
          test -f tools/mergewiki/requirements.txt
          test -f tools/mergewiki/main.py
          test -f tools/mergewiki/render_pr_comment.py

      # 4) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 5) Install dependencies
      - name: Install tool dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/mergewiki/requirements.txt

      # 6) Run resolver (MR mode) -> output/result.json
      - name: Run MergeWiki resolver
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python tools/mergewiki/main.py \
            --repo . \
            --branchA pr_head \
            --branchB ${{ github.event.pull_request.base.sha }} \
            --base-url "https://openrouter.ai/api/v1" \
            -o output

      # 7) Render PR comment markdown -> comment.md
      - name: Render PR comment
        run: |
          python tools/mergewiki/render_pr_comment.py output/result.json \
            -o comment.md \
            --max-blocks 12

      # 8) Create or update PR comment (idempotent via marker)
      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.md', 'utf8');

            // 必须与你渲染器中的 marker 一致
            const marker = '<!-- llm-merge-resolver -->';

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 }
            );

            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

      # 9) Upload artifacts for debugging
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mergewiki-output
          path: |
            output/
            comment.md
          if-no-files-found: error
