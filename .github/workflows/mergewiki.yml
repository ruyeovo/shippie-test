name: LLM Merge Conflict Resolver

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: llm-merge-resolver-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  resolve:
    # fork PR 默认拿不到 secrets；先跳过（更安全、避免无意义失败）
    if: ${{ github.event.pull_request.draft == false && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base (trusted)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0

      - name: Fetch PR head
        run: |
          git fetch --no-tags origin ${{ github.event.pull_request.head.sha }}:pr_head

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run resolver (MR mode)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python main.py \
            --repo . \
            --branchA pr_head \
            --branchB ${{ github.event.pull_request.base.sha }} \
            --api-key "$OPENROUTER_API_KEY" \
            --base-url "https://openrouter.ai/api/v1" \
            -o output

      - name: Render PR comment markdown
        run: |
          python render_pr_comment.py output/result.json -o comment.md --max-blocks 12

      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.md', 'utf8');
            const marker = '<!-- llm-merge-resolver -->';

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 }
            );

            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number,
                body
              });
            }

      - name: Upload output artifact
        uses: actions/upload-artifact@v4
        with:
          name: llm-merge-resolver-output
          path: output/
          if-no-files-found: error
